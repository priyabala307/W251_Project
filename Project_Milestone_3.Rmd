---
title: "PBHLTH W251 Project Milestone 3"
author: "Priya Bala and Mihir Pandya"
date: "2023-11-06"
output: html_document
---

#### **Data Cleaning: Milestone 3**

The sim_flu_CA.csv file and sim_flu_LACounty.csv file together represent simulated morbidity for the entire state of California. While it's certainly possible for data from different sources to adhere to a format standard, one of the challenges of working with secondary data is that it often does not work out that way. Therefore to prepare each dataset (milestone #3) so that they can be combined into one, whole state, dataset you will need to do the following:

-   Flu morbidity datasets (from CA and LA County)

    -   Recode column names, values, or formats that are in discordant (dates, etc)

    -   Combine morbidity datasets into a single dataset

    -   Select demographic and geographic strata (s) of interest

    -   Aggregate the data into a new dataframe to  include only one row per strata of interest

-   Vaccination dataset 

    -   Recode values to be consistent with morbidity datasets so they can be joined

    -   Select vaccination time frame that fits best with morbidity data and subset appropriately

    -   Select demographic strata(s) of interest

    -   Create a vaccination rate metric and summarize to include only one row per strata of interest

### Clean each dataset and include descriptive statistics for relevant data elements

Please turn in an html document created from an Rmd or Qmd with the following components:

-   Subset rows or columns, as needed

-   Create new variables needed for analysis (minimum 2)

    -   New variables should be created based on existing columns; for example

        -   Calculating a rate

        -   Combining character strings

        -   Aggregation

-   Clean variables needed for analysis (minimum 2)

    -   Examples

        -   Recode invalid values

        -   Handle missing data

        -   Recode categories

-   Data re-structured as needed (aggregated/summarized and/or pivoted)

-   Data dictionary based on clean dataset (minimum 4 data elements), including:

    -   Variable name

    -   Data type

    -   Description

-   One or more tables with descriptive statistics for 4 data elements

-   Html output that is professionally prepared for presentation

    -   Only the necessary information is outputted (you should suppress, for example, entire data frame outputs)

    -   Use of headers and sub headers to create an organized document

```{r}
# Adding all the packages that are necessary for the cleaning and importing done
# in this milestone. We are using readr, tidyverse, dplyr.

library(readr)
library(tidyverse)
library(dplyr)
library(knitr)
library(kableExtra)
```

```{r}
# Importing the CA dataset and the LA dataset

sim_CA <- read_csv("./sim_flu_CA.csv")
head(sim_CA)

sim_LA <- read_csv("./sim_flu_LACounty_pop.csv")
head(sim_LA)

# Importing the vaccination dataset

ca_vax <- read_csv("./ca_vax_rates_quarter.csv")
head(ca_vax)
```

Renaming the column names

```{r}
# Renaming the columns in the sim_LA dataset

sim_LA <- rename_with(sim_LA,
                      ~ tolower(
                        gsub(" ",
                             "",
                             .x,
                             fixed = TRUE)
                      ))

ca_vax <- rename_with(ca_vax,
                      ~ tolower(
                        gsub(" ",
                             "_",
                             .x,
                             fixed = TRUE)
                      ))

# Renaming specific columns to match the column names in all the three datasets

sim_CA <- sim_CA %>% rename(county_name = county)
sim_CA <- sim_CA %>% rename(population = pop)
head(ca_vax)
head(sim_CA)
head(sim_LA)
```

We are first going to append sim_CA and sim_LA

```{r}

sim_LA <- sim_LA %>% rename(new_recovered = recovered_new, current_infected = infected_current, new_infections = dx_new, count_susceptible = susceptible, cumulative_infected = infected_cumulative, cumulative_recovered = recovered_cumulative, new_severe = severe_new, cumulative_severe = severe_cumulative, dt_diagnosis = dt_dx, age_cat = age_category, report_date = dt_report)

sim_CA <- sim_CA %>% rename(unique_id = time_int)

# Creating county_name column for the LA dataset

sim_LA <- sim_LA %>% mutate(county_name = "Los Angeles County")
head(sim_LA)

colnames(sim_CA)
colnames(sim_LA)
```

Now that the column have been renamed to create a consistent dataset, we are adjusting the data types and formatting some of the columns to the appropriate data type.

```{r}
# For the LA dataset

sim_LA$dt_diagnosis <- as.Date(sim_LA$dt_diagnosis, format = "%d%b%Y")

# Converting race_ethnicity using case_when

sim_CA <- sim_CA %>%
  mutate(race_eth = case_when(
    race_ethnicity == 1 ~ "American Indian or Alaska Native",
    race_ethnicity == 2 ~ "Asian",
    race_ethnicity == 3 ~ "Black or African American",
    race_ethnicity == 4 ~ "Latino",
    race_ethnicity == 5 ~ "Native Hawaiian or Other Pacific Islander",
    race_ethnicity == 6 ~ "Multiracial",
    race_ethnicity == 7 ~ "Other/Unknown"
  ))

head(sim_LA)
head(sim_CA)
```

```{r}
# This chunk is combining both datasets to one dataset
# Removing the columns in the sim_CA dataset that are not present
# in the sim_LA dataset to combine both the datasets

sim_CA_subset <- sim_CA[,-c(2,9,10,15,16)]

# Reordering the columns

sim_LA <- sim_LA[, names(sim_CA_subset)]
colnames(sim_LA)
colnames(sim_CA_subset)

# Appending both the datasets and combining sim_LA and sim_CA_subset

sim_CA_LA <- rbind(sim_CA_subset, sim_LA)
head(sim_CA_LA)
```

We are choosing the age category as a sociodemographic category and we are focusing on

Alameda County.

```{r}
# Subsetting the combined dataset to only include age and Alameda County
# First subsetting the dataset to only have Alameda County observations

sim_CA_LA_age_subset <- sim_CA_LA[sim_CA_LA$county_name == "Alameda County", ]

# Since we are focusing only on age as a demographic characteristic,
# we can remove race_eth and sex columns

sim_CA_LA_age_subset <- sim_CA_LA_age_subset[,-c(11,14)]
head(sim_CA_LA_age_subset)

str(sim_CA_LA_age_subset)
```

```{r}

sim_Cali_aggregated <- sim_CA_LA_age_subset %>%
  drop_na(count_susceptible, current_infected, cumulative_infected, cumulative_recovered, cumulative_severe, population) %>%
  group_by(county_name, age_cat) %>%
  summarise(
    mean_new_infections = mean(new_infections),
    mean_new_recovered = mean(new_recovered),
    count_susceptible = last(count_susceptible),
    mean_current_infected = mean(current_infected),
    cumulative_infected = last(cumulative_infected),
    cumulative_recovered = last(cumulative_recovered),
    new_severe = sum(new_severe),
    cumulative_severe = last(cumulative_severe),
    population = last(population)
  )

print(sim_Cali_aggregated)
```

Cleaning the California vaccination dataset

```{r}
# Recoding the column names to match morbidity datasets to ready them to join

ca_vax_renamed <- rename_with(ca_vax,
                      ~ tolower(
                        gsub(" ",
                             "_",
                             .x,
                             fixed = TRUE)
                      ))
```

```{r}
# Selecting a time frame that matches the morbidity dataset and subset

ca_vax_time_frame <- subset(ca_vax_renamed, quarter == "2023-04-01")
```

```{r}
# Selecting demographic strata of interest

ca_demographics <- subset(ca_vax_time_frame, demographic_category == "Age Group")

ca_demographics <- ca_demographics %>%
  rename("age_cat" = "demographic_value")
```

```{r}
# Remaining modifications to enable merge

ca_vax_county <- subset(ca_demographics, county_name == "Alameda")

ca_vax_county$age_cat = case_when(
    ca_vax_county$age_cat == "Under 5" ~ "0-17",
    ca_vax_county$age_cat == "5-11" ~ "0-17",
    ca_vax_county$age_cat == "12-17" ~ "0-17",
    ca_vax_county$age_cat == "18-49" ~ "18-49",
    ca_vax_county$age_cat == "50-64" ~ "50-64",
    ca_vax_county$age_cat == "65+" ~ "65+")

head(ca_vax_county)
```

```{r}

subset_data_age_17 <- ca_vax_county %>%
  filter(age_cat == "0-17")

head(subset_data_age_17)

ca_vax_county_age_no17 <- ca_vax_county %>%
  filter(age_cat != "0-17")

head(ca_vax_county_age_no17)

ca_vax_county_age_no17 <- ca_vax_county_age_no17[,-c(2,3)]
```

```{r}
# Assuming your dataset is named ca_vax_county, the following code
# can be used to aggregate the data into a single row

aggregated_data_17 <- subset_data_age_17 %>%
  group_by(age_cat) %>%
  summarise(
    estimated_population = sum(estimated_population),
    total_partial_vaccinated = sum(total_partial_vaccinated),
    cumulative_fully_vaccinated = sum(cumulative_fully_vaccinated),
    cumulative_at_least_one_dose = sum(cumulative_at_least_one_dose),
    cumulative_unvaccinated = sum(cumulative_unvaccinated),
    cumulative_up_to_date_vax = sum(cumulative_up_to_date_vax),
    county_name = county_name,
    dt_admin = dt_admin,
    suppress_data = suppress_data,
    quarter = quarter
  ) %>%
  distinct()

head(aggregated_data_17)

order <- c("county_name", "age_cat", "estimated_population", "dt_admin", "total_partial_vaccinated", "cumulative_fully_vaccinated", "cumulative_at_least_one_dose", "cumulative_unvaccinated", "suppress_data", "cumulative_up_to_date_vax", "quarter")

# Reorder the columns of the first dataset
aggregated_data_17 <- aggregated_data_17[, order]

head(aggregated_data_17)

ca_vax_county_final <- rbind(aggregated_data_17, ca_vax_county_age_no17)
print(ca_vax_county_final)
```

We are calculating the vaccination rate for the California vaccination dataset

```{r}
# Creating vaccination rate metric

ca_vax_county_final <- ca_vax_county_final %>%
  mutate(vaccination_rate = (cumulative_fully_vaccinated / estimated_population) * 100)

head(ca_vax_county_final)
```

Now that we have created an aggregated ca_vax dataset that is only for Alameda County in the April 1st 2023 quarter with age categories as the chosen demographic characteristic, we can combine the California vaccine dataset with the simulated dataset.

```{r}
# Combining the two final datasets to create one final dataset

# The ca_vax_county_final dataset has its county_name variables as Alameda
# rather than Alameda County, thus we are adding additional cleaning
# to make the merger of the combined datasets easier

ca_vax_county_final <- ca_vax_county_final %>% mutate(county_name = case_when(
    county_name == "Alameda" ~ "Alameda County"))

# Merging the two final datasets

merged_final_alameda <- merge(sim_Cali_aggregated, ca_vax_county_final, by = "age_cat", all = TRUE)
print(merged_final_alameda)
```

Doing some final cleaning for the dataset

```{r}

merged_final_alameda <- merged_final_alameda %>% rename(county_name = county_name.x)

merged_final_alameda <- merged_final_alameda[,-c(12)]

print(merged_final_alameda)
```

```{r}
# Switching the first and second columns in the final merged dataset

merged_final_alameda <- merged_final_alameda[,c(2,1,3:21)]

print(merged_final_alameda)
```

Creating a descriptive table from the final merged dataset

```{r}
# Assuming "merged_final_alameda" is the dataset

# Defining the columns wanted to compute the descriptive statistics
columns <- c(
  "total_partial_vaccinated",
  "cumulative_fully_vaccinated",
  "vaccination_rate",
  "cumulative_unvaccinated",
  "cumulative_infected",
  "cumulative_recovered",
  "population",
  "cumulative_at_least_one_dose",
  "cumulative_up_to_date_vax"
)

# Creating an empty data frame
result_table <- data.frame(
  Measure = c("Min", "1st Qu", "Median", "Mean", "3rd Qu", "Max", "Standard Deviation")
)

# Looping through each column
for (col in columns) {
  # Compute summary statistics
  summary_stats <- summary(merged_final_alameda[[col]])
  sd_value <- sd(merged_final_alameda[[col]])

  # Adding the results to the data frame
  result_table[[col]] <- c(summary_stats[1], summary_stats[2], summary_stats[3], mean(merged_final_alameda[[col]]), summary_stats[5], summary_stats[6], sd_value)
}

# Print the resulting table
print(result_table)
```

```{r}

kable(result_table, format = "markdown", align = "c", booktabs = TRUE) %>%
  kable_styling(latex_options = c("striped", "hold_position"), full_width = FALSE)
```

Data dictionary (sample):

1. vaccination_rate - a numeric describing the cumulative number of people
fully vaccinated over the estimated total population, times 100

2. mean_new_infections - a numeric describing the average number of new cases
after monitoring started (akin to incidence)

3. mean_new_recovered - a numeric describing the average number of recovered patients
after monitoring started (akin to incidence)

4. cumulative_infected - a numeric describing the total number of cases,
including before monitoring started (akin to prevalence)

5. cumulative_recovered - a numeric describing the total number of recovered patients,
including before monitoring started (akin to prevalence)

6. estimated population - a numeric describing the estimated total population
of the county of interest

7. quarter - a numeric in the form of a date describing the quarter (three months
starting on the date listed) for which the data was collected in the county of
interest
