---
title: "PBHLTH W251 Project Milestone 3"
author: "Priya Bala and Mihir Pandya"
date: "2023-11-06"
output: html_document
---

#### **Data Cleaning: Milestone 3**

The sim_flu_CA.csv file and sim_flu_LACounty.csv file together represent simulated morbidity for the entire state of California. While it's certainly possible for data from different sources to adhere to a format standard, one of the challenges of working with secondary data is that it often does not work out that way. Therefore to prepare each dataset (milestone #3) so that they can be combined into one, whole state, dataset you will need to do the following:

-   Flu morbidity datasets (from CA and LA County)

    -   Recode column names, values, or formats that are in discordant (dates, etc) - DONE

    -   Combine morbidity datasets into a single dataset - DONE

    -   Select demographic and geographic strata (s) of interest - DONE

    -   Aggregate the data into a new dataframe to  include only one row per strata of interest

-   Vaccination dataset 

    -   Recode values to be consistent with morbidity datasets so they can be joined

    -   Select vaccination time frame that fits best with morbidity data and subset appropriately

    -   Select demographic strata(s) of interest

    -   Create a vaccination rate metric and summarize to include only one row per strata of interest

### Clean each dataset and include descriptive statistics for relevant data elements

Please turn in an html document created from an Rmd or Qmd with the following components:

-   Subset rows or columns, as needed

-   Create new variables needed for analysis (minimum 2)

    -   New variables should be created based on existing columns; for example

        -   Calculating a rate

        -   Combining character strings

        -   Aggregation

-   Clean variables needed for analysis (minimum 2)

    -   Examples

        -   Recode invalid values

        -   Handle missing data

        -   Recode categories

-   Data re-structured as needed (aggregated/summarized and/or pivoted)

-   Data dictionary based on clean dataset (minimum 4 data elements), including:

    -   Variable name

    -   Data type

    -   Description

-   One or more tables with descriptive statistics for 4 data elements

-   Html output that is professionally prepared for presentation

    -   Only the necessary information is outputted (you should suppress, for example, entire data frame outputs)

    -   Use of headers and sub headers to create an organized document

```{r}
# Adding all the packages that are necessary for the cleaning and importing done
# in this milestone. We are using readr, tidyverse, dplyr.

library(readr)
library(tidyverse)
library(dplyr)
```

```{r}
# Importing the CA dataset and the LA dataset

sim_CA <- read_csv("./sim_flu_CA.csv")
View(sim_CA)

sim_LA <- read_csv("./sim_flu_LACounty_pop.csv")
View(sim_LA)

# Importing the vaccination dataset

ca_vax <- read_csv("./ca_vax_rates_quarter.csv")
View(ca_vax)
```

Renaming the column names

```{r}
# Renaming the columns in the sim_LA dataset

sim_LA <- rename_with(sim_LA,
                      ~ tolower(
                        gsub(" ",
                             "",
                             .x,
                             fixed = TRUE)
                      ))

ca_vax <- rename_with(ca_vax,
                      ~ tolower(
                        gsub(" ",
                             "_",
                             .x,
                             fixed = TRUE)
                      ))

# Renaming specific columns to match the column names in all the 3 datasets

sim_CA <- sim_CA %>% rename(county_name = county)
sim_CA <- sim_CA %>% rename(population = pop)
head(ca_vax)
head(sim_CA)
head(sim_LA)
```

We are first going to append sim_CA and sim_LA.

```{r}

sim_LA <- sim_LA %>% rename(new_recovered = recovered_new, current_infected = infected_current, new_infections = dx_new, count_susceptible = susceptible, cumulative_infected = infected_cumulative, cumulative_recovered = recovered_cumulative, new_severe = severe_new, cumulative_severe = severe_cumulative, dt_diagnosis = dt_dx, age_cat = age_category, report_date = dt_report)

sim_CA <- sim_CA %>% rename(unique_id = time_int)

# Creating county_name column for the LA dataset

sim_LA <- sim_LA %>% mutate(county_name = "Los Angeles County")
View(sim_LA)

colnames(sim_CA)
colnames(sim_LA)
```

Now that the column have been renamed to create a consistent dataset, we are adjusting the data types and formatting some of the columns to the appropriate data type.

```{r}
# For the LA dataset

sim_LA$dt_diagnosis <- as.Date(sim_LA$dt_diagnosis, format = "%d%b%Y")

# Converting race_ethnicity using case_when

sim_CA <- sim_CA %>% 
  mutate(race_eth = case_when(
    race_ethnicity == 1 ~ "American Indian or Alaska Native",
    race_ethnicity == 2 ~ "Asian",
    race_ethnicity == 3 ~ "Black or African American",
    race_ethnicity == 4 ~ "Latino",
    race_ethnicity == 5 ~ "Native Hawaiian or Other Pacific Islander",
    race_ethnicity == 6 ~ "Multiracial",
    race_ethnicity == 7 ~ "Other/Unknown"
  ))

View(sim_LA)
View(sim_CA)
```

```{r}
# This chunk is combining both datasets to one dataset
# Removing the columns in the sim_CA dataset that are not present
# in the sim_LA dataset to combine both the datasets

sim_CA_subset <- sim_CA[,-c(2,9,10,15,16)]

# Reordering the columns

sim_LA <- sim_LA[, names(sim_CA_subset)]
colnames(sim_LA)
colnames(sim_CA_subset)

# Appending both the datasets and combining sim_LA and sim_CA_subset

sim_CA_LA <- rbind(sim_CA_subset, sim_LA)
head(sim_CA_LA)
```

We are choosing the age category as a sociodemographic category and we are focusing on Alameda County.

```{r}
# Subsetting the combined dataset to only include age and Alameda County
# First subsetting the dataset to only have Alameda County observations

sim_CA_LA_age_subset <- sim_CA_LA[sim_CA_LA$county_name == "Alameda County", ]

# Since we are focusing only on age as a demographic characteristic,
# we can remove race_eth and sex columns

sim_CA_LA_age_subset <- sim_CA_LA_age_subset[,-c(11,14)]
View(sim_CA_LA_age_subset)

str(sim_CA_LA_age_subset)
```

```{r}

str(sim_CA_LA_age_subset)
```

```{r}

aggregated_df <- sim_CA_LA_age_subset %>%
  drop_na(count_susceptible, current_infected, cumulative_infected, cumulative_recovered, cumulative_severe, population) %>%
  group_by(county_name, age_cat) %>%
  summarise(
    mean_new_infections = mean(new_infections),
    mean_new_recovered = mean(new_recovered),
    count_susceptible = last(count_susceptible),
    mean_current_infected = mean(current_infected),
    cumulative_infected = last(cumulative_infected),
    cumulative_recovered = last(cumulative_recovered),
    new_severe = sum(new_severe),
    cumulative_severe = last(cumulative_severe),
    population = last(population)
  )

print(aggregated_df)
```

Cleaning the California Vaccination dataset

```{r}
# Recoding the column names to match morbidity datasets to ready them to join

ca_vax_renamed <- rename_with(ca_vax,
                      ~ tolower(
                        gsub(" ",
                             "_",
                             .x,
                             fixed = TRUE)
                      ))
```

```{r}
# Selecting a time frame that matches the morbidity dataset and subset

ca_vax_time_frame <- subset(ca_vax_renamed, quarter == "2023-04-01")
```

```{r}
# Selecting demographic strata of interest

ca_demographics <- subset(ca_vax_time_frame, demographic_category == "Age Group")
```

```{r}
# Creating vaccination rate metric

ca_metric <- mutate(
  ca_demographics,
  "vaccination_rate" = 
    (ca_demographics$cumulative_fully_vaccinated / ca_demographics$estimated_population) * 100)

ca_metric <- ca_metric %>%
  rename("age_cat" = "demographic_value")
```

```{r}

colnames(ca_metric)
View(ca_metric)
```

```{r}
# We are merging the subsetted sim_CA_LA_age_subset and ca_metric dataset. 

merged_final <- merge(sim_CA_LA_age_subset, ca_metric, by = "county_name")
View(merged_final)

# Remaining modifications to enable merge

ca_vax_county <- subset(ca_metric, county_name == "Alameda")

ca_vax_county$age_cat = case_when(
    ca_vax_county$age_cat == "Under 5" ~ "0-17",
    ca_vax_county$age_cat == "5-11" ~ "0-17",
    ca_vax_county$age_cat == "12-17" ~ "0-17",
    ca_vax_county$age_cat == "18-49" ~ "18-49",
    ca_vax_county$age_cat == "50-64" ~ "50-64",
    ca_vax_county$age_cat == "65+" ~ "65+")

```
